/**
 * Dwolla Payment Button Helper Script
 *
 * @version 3.0.0
 * @author Michael Schonfeld <michael@dwolla.com>
 * @url https://developers.dwolla.com
 */(function(e){e.DOMReady=function(){var t=[],n=!1,r=null,i=function(e,t){try{e.apply(this,t||[])}catch(n){r&&r.call(this,n)}},s=function(){n=!0;for(var e=0;e<t.length;e++)i(t[e].fn,t[e].args||[]);t=[]};this.setOnError=function(e){r=e;return this};this.add=function(e,r){n?i(e,r):t[t.length]={fn:e,args:r};return this};e.addEventListener?e.document.addEventListener("DOMContentLoaded",function(){s()},!1):function(){if(!e.document.uniqueID&&e.document.expando)return;var t=e.document.createElement("document:ready");try{t.doScroll("left");s()}catch(n){setTimeout(arguments.callee,0)}}();return this}()})(window);if(!window.Element){Element=function(){};var __createElement=document.createElement;document.createElement=function(e){var t=__createElement(e);for(var n in Element.prototype)t[n]=Element.prototype[n];return t};var __getElementById=document.getElementById;document.getElementById=function(e){var t=__getElementById(e);for(var n in Element.prototype)t[n]=Element.prototype[n];return t}}var addEvent=function(){var e=function(t,n,r){t.addEventListener?e=function(e,t,n){e.addEventListener(t,n,!1)}:t.attachEvent?e=function(e,t,n){e.attachEvent("on"+t,n)}:e=function(e,t,n){e["on"+t]=n};e(t,n,r)};return function(t,n,r){e(t,n,r)}}();getElsByClass=function(e){var t,n,r,i,s,o;if(typeof document.getElementsByClassName=="function")return document.getElementsByClassName(e);if(typeof document.querySelectorAll=="function")return document.querySelectorAll("."+e);n=new RegExp("(^|\\s)"+e+"(\\s|$)");s=document.getElementsByTagName("*");o=[];for(r=0,i=s.length;r<i;r++){t=s[r];n.test(t.className)&&o.push(t)}return o};var DwollaBtn=DwollaBtn||function(){var e={cssURI:"http://www.dwolla.com/content/button.min.css",dwollaPayAction:"https://www.dwolla.com/payment/pay",dwollaMisconfiguredPage:"https://developers.dwolla.com/button"};return{_skip:function(e){return e.nextSibling&&e.nextSibling.className&&e.nextSibling.className.indexOf("d-btn")!==-1?!0:!1},_createButton:function(t,n,r){r==null&&(r=!1);var i=document.createElement("a"),s=document.createElement("span");s.setAttribute("class","d-btn-text");s.appendChild(document.createTextNode(r||t.getAttribute("data-label")));i.appendChild(s);var o=document.createElement("span");o.setAttribute("class","d-btn-icon");i.appendChild(o);i.setAttribute("class","d-btn "+n);i.setAttribute("href",e.dwollaMisconfiguredPage);for(var u=0;u<t.attributes.length;u++)t.attributes[u].nodeName.substr(0,5)=="data-"&&i.setAttribute(t.attributes[u].nodeName,t.attributes[u].nodeValue);return i},_parse:function(e){var t=[],n=e.split("|||");for(var r=0;r<n.length;r++){var i=n[r].split(":::"),s={};s.name=i[0];s.price=i[1];s.name&&s.price&&t.push(s)}return t},init:function(){this.appendCSS();this.createMarkup();this.registerButtons();this.handleResponse();return!0},appendCSS:function(){if(document.getElementById("dwolla-button-stylesheet"))return!1;var t=document.createElement("link");t.setAttribute("rel","stylesheet");t.setAttribute("type","text/css");t.setAttribute("href",e.cssURI);t.setAttribute("id","dwolla-button-stylesheet");document.getElementsByTagName("head")[0].appendChild(t)},createMarkup:function(){var e=getElsByClass("dwolla_button");for(var t=0;t<e.length;t++){var n=e[t],r=n.getAttribute("data-type");if(!r||typeof r=="undefined"){if(n.className.indexOf("d-btn")!==-1)return;n.setAttribute("data-redirect",n.getAttribute("href"));n.setAttribute("data-description",n.getAttribute("data-desc"));var i=this._createButton(n,"d-btn-legacy",n.firstChild.nodeValue);n.parentNode.replaceChild(i,n)}else if(r=="simple"){if(this._skip(n))return;var i=this._createButton(n,"d-btn-simple");n.parentNode.insertBefore(i,n.nextSibling)}else if(r=="freetype"){if(this._skip(n))return;var i=this._createButton(n,"d-btn-freetype"),s=document.createElement("input");s.setAttribute("type","text");s.setAttribute("onClick","this.select();");addEvent(s,"keyup",function(e){e.keyCode==13&&DwollaBtn.submitButton(this.parentNode)});s.value=n.getAttribute("data-amount");i.appendChild(s);n.parentNode.insertBefore(i,n.nextSibling)}else if(r=="options"){if(this._skip(n))return;var i=this._createButton(n,"d-btn-options"),o=document.createElement("select"),u=this._parse(n.getAttribute("data-options")),a=document.createElement("option");a.setAttribute("disabled","disabled");a.setAttribute("selected","selected");a.innerHTML="Choose...";o.appendChild(a);for(var f=0;f<u.length;f++){var l=document.createElement("option");l.value=u[f].price+":"+u[f].name;l.innerHTML=u[f].name+" ($"+u[f].price+")";o.appendChild(l)}i.appendChild(o);addEvent(o,"change",function(e){var t=this.value.substr(0,this.value.indexOf(":")),n=this.value.substr(this.value.indexOf(":")+1);this.parentNode.setAttribute("data-amount",t.replace("$",""));this.parentNode.setAttribute("data-name",n);DwollaBtn.submitButton(this.parentNode)});i.setAttribute("data-amount","");i.setAttribute("data-name","");n.parentNode.insertBefore(i,n.nextSibling)}}},registerButtons:function(){var e=function(e,t){var n=function(e){return e.className.indexOf("d-btn")!==-1&&e.nodeName=="A"};return n(e)?e:n(t)?t:!1},t=function(t){var n=t.target||t.srcElement,r=n.parentNode,i;if(i=e(n,r)){t.preventDefault?t.preventDefault():t.returnValue=!1;if(n.nodeName=="INPUT"||n.nodeName=="SELECT"||n.nodeName=="OPTION")return!1;DwollaBtn.submitButton(i);return!1}};addEvent(document,"click",t)},handleResponse:function(){var e=function(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))};e("error")=="failure"&&e("error_description")&&alert("There seems to have been a problem with the transaction. Dwolla said: "+e("error_description"));return!0},submitButton:function(t){if(!t||t.nodeName!="A")return!1;if(t.getAttribute("data-type")=="freetype"){var n=t.getElementsByTagName("INPUT")[0].value;t.setAttribute("data-amount",n.replace("$",""))}if(!t.getAttribute("data-amount"))return!1;var r=document.createElement("form");r.setAttribute("method","POST");r.setAttribute("action",e.dwollaPayAction);var i={destinationId:null,amount:t.getAttribute("data-amount"),shipping:t.getAttribute("data-shipping"),tax:t.getAttribute("data-tax"),name:t.getAttribute("data-name"),description:t.getAttribute("data-description"),redirect:t.getAttribute("data-redirect"),key:t.getAttribute("data-key"),orderId:t.getAttribute("data-orderid"),facilitatorAmount:t.getAttribute("data-facilitator-fee"),notes:t.getAttribute("data-notes"),test:t.getAttribute("data-test"),allowFundingSources:t.getAttribute("data-guest-checkout"),callback:t.getAttribute("data-callback")};for(key in i)if(i[key]!=null){var s=document.createElement("input");s.setAttribute("type","hidden");s.setAttribute("name",key);s.setAttribute("value",i[key]);r.appendChild(s)}document.getElementsByTagName("body")[0].appendChild(r);r.submit()}}}();DOMReady.add(function(){DwollaBtn.init();addEvent(document,"DOMSubtreeModified",function(){DwollaBtn.init()})});